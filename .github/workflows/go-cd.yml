name: Go CD Continuous Deployment

on:
 workflow_run:
   workflows: ["Continuous Integration"]
   branches: [ main ]
   types:
     - completed


jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts

    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ec2-user
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo systemctl stop listaPro.service
          mv listaPro /home/ec2-user/listaPro/
          cp .env /home/ec2-user/listaPro/.env
          sudo systemctl restart listaPro.service
